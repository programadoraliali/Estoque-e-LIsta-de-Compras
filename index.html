<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FamilyStock MVP</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    section { margin-bottom: 2em; }
    form label { display: block; margin-top: 0.5em; }
  </style>
</head>
<body>
<h1>FamilyStock MVP</h1>

<section id="auth">
  <h2>Register</h2>
  <form id="register-form">
    <label>Name <input type="text" id="reg-name" required></label>
    <label>Email <input type="email" id="reg-email" required></label>
    <label>Password <input type="password" id="reg-password" required></label>
    <button type="submit">Register</button>
  </form>
  <h2>Login</h2>
  <form id="login-form">
    <label>Email <input type="email" id="log-email" required></label>
    <label>Password <input type="password" id="log-password" required></label>
    <button type="submit">Login</button>
  </form>
</section>

<section id="family" style="display:none">
  <h2>Create Family</h2>
  <form id="family-form">
    <label>Name <input type="text" id="family-name" required></label>
    <button type="submit">Create</button>
  </form>
</section>

<section id="app" style="display:none">
  <h2>Categories</h2>
  <form id="cat-form">
    <label>Name <input type="text" id="cat-name" required></label>
    <button type="submit">Add Category</button>
  </form>
  <ul id="cat-list"></ul>

  <h2>Products</h2>
  <form id="product-form">
    <label>Name <input type="text" id="prod-name" required></label>
    <label>Quantity <input type="number" id="prod-quantity" value="1" step="0.01" required></label>
    <label>Minimum <input type="number" id="prod-minimum" value="1" step="0.01" required></label>
    <label>Unit <input type="text" id="prod-unit" value="unit" required></label>
    <label>Category
      <select id="prod-category"></select>
    </label>
    <button type="submit">Add Product</button>
  </form>
  <ul id="product-list"></ul>

  <h2>Auto Shopping List</h2>
  <button id="generate-btn">Generate</button>
  <ul id="list-items"></ul>
</section>

<script>
let userId = localStorage.getItem('userId');
let familyId = localStorage.getItem('familyId');

function show(id, visible) {
  document.getElementById(id).style.display = visible ? '' : 'none';
}

function updateView() {
  show('auth', !userId);
  show('family', userId && !familyId);
  show('app', userId && familyId);
  if (familyId) {
    loadCategories();
    loadProducts();
    loadLists();
  }
}

async function register(e) {
  e.preventDefault();
  const name = document.getElementById('reg-name').value;
  const email = document.getElementById('reg-email').value;
  const password = document.getElementById('reg-password').value;
  await fetch('/api/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, email, password })
  });
  alert('Registered! Please login.');
  e.target.reset();
}

async function login(e) {
  e.preventDefault();
  const email = document.getElementById('log-email').value;
  const password = document.getElementById('log-password').value;
  const res = await fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  });
  if (res.ok) {
    const data = await res.json();
    userId = data.id;
    localStorage.setItem('userId', userId);
    updateView();
  } else {
    alert('Login failed');
  }
}

async function createFamily(e) {
  e.preventDefault();
  const name = document.getElementById('family-name').value;
  const res = await fetch('/api/families', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, userId })
  });
  if (res.ok) {
    const family = await res.json();
    familyId = family.id;
    localStorage.setItem('familyId', familyId);
    updateView();
  }
}

async function loadCategories() {
  const res = await fetch(`/api/families/${familyId}/categories`);
  const cats = await res.json();
  const list = document.getElementById('cat-list');
  const select = document.getElementById('prod-category');
  list.innerHTML = '';
  select.innerHTML = '';
  cats.forEach(c => {
    const li = document.createElement('li');
    li.textContent = c.name;
    list.appendChild(li);
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    select.appendChild(opt);
  });
}

async function addCategory(e) {
  e.preventDefault();
  const name = document.getElementById('cat-name').value;
  await fetch(`/api/families/${familyId}/categories`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name })
  });
  e.target.reset();
  loadCategories();
}

async function loadProducts() {
  const res = await fetch(`/api/families/${familyId}/products`);
  const products = await res.json();
  const list = document.getElementById('product-list');
  list.innerHTML = '';
  products.forEach(p => {
    const li = document.createElement('li');
    li.textContent = `${p.name} - ${p.current_quantity}${p.unit}`;
    list.appendChild(li);
  });
}

async function addProduct(e) {
  e.preventDefault();
  const name = document.getElementById('prod-name').value;
  const quantity = document.getElementById('prod-quantity').value;
  const minimum = document.getElementById('prod-minimum').value;
  const unit = document.getElementById('prod-unit').value;
  const categoryId = document.getElementById('prod-category').value;
  await fetch(`/api/families/${familyId}/products`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, quantity, minimum, unit, categoryId, userId })
  });
  e.target.reset();
  loadProducts();
}

async function generateList() {
  const res = await fetch(`/api/families/${familyId}/shopping-lists/auto`, { method: 'POST' });
  const list = await res.json();
  const ul = document.getElementById('list-items');
  ul.innerHTML = '';
  list.items.forEach(it => {
    const li = document.createElement('li');
    li.textContent = `${it.quantity} ${it.unit} - ${it.productId}`;
    ul.appendChild(li);
  });
}

async function loadLists() {
  const res = await fetch(`/api/families/${familyId}/shopping-lists`);
  const lists = await res.json();
  if (lists.length) {
    const last = lists[lists.length - 1];
    const ul = document.getElementById('list-items');
    ul.innerHTML = '';
    last.items.forEach(it => {
      const li = document.createElement('li');
      li.textContent = `${it.quantity} ${it.unit} - ${it.productId}`;
      ul.appendChild(li);
    });
  }
}

document.getElementById('register-form').addEventListener('submit', register);
document.getElementById('login-form').addEventListener('submit', login);
document.getElementById('family-form').addEventListener('submit', createFamily);
document.getElementById('cat-form').addEventListener('submit', addCategory);
document.getElementById('product-form').addEventListener('submit', addProduct);
document.getElementById('generate-btn').addEventListener('click', generateList);

updateView();
</script>
</body>
</html>
